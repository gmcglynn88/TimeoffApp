<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Time by IPI</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;700&display=swap">
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
      --available-color: #c8e6c9;
      --nearly-color:    #ffe0b2;
      --full-color:      #ffcdd2;
    }
    /* … existing styles unchanged … */
    .calendar-filters .filters {
      display: flex; gap: 15px; flex-wrap: wrap;
      padding: 20px; background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }
    .calendar { display: grid; grid-template-columns: repeat(7,1fr); gap:10px; padding:20px;
      background: var(--card-bg); overflow:auto; border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .calendar .day {
      border:1px solid var(--border-color); border-radius:4px;
      padding:8px; min-height:80px; display:flex; flex-direction:column;
      justify-content:space-between;
    }
    .calendar .day .date { font-weight:600; margin-bottom:6px; }
    .calendar .day .balance-info { font-size:12px; color:var(--text-light); line-height:1.2; }
  </style>
</head>
<body>
  <header>
    <h1>Your Time by IPI</h1>
    <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="Consulting Logo" class="logo">
  </header>
  <hr class="divider">

  <div class="tab-container">
    <div class="tab">
      <button class="tablinks" onclick="openTab(event,'TimeOffBalances')" id="defaultOpen">Time Off Balances</button>
      <button class="tablinks" onclick="openTab(event,'Calculator')">Calculator</button>
      <button class="tablinks" onclick="openTab(event,'TimeOffCalendar')">Time Off Calendar</button>
    </div>
    <div class="button-container">
      <label class="import-button-label">Import Balances<input type="file" id="import-file" accept=".csv" onchange="importTableFromCSV(event)"></label>
      <button class="save-button" onclick="saveChanges()">Save</button>
    </div>
  </div>

  <div class="main-content">
    <div id="TimeOffBalances" class="tabcontent">
      <!-- … existing content … -->
    </div>

    <div id="Calculator" class="tabcontent">
      <!-- … existing content … -->
    </div>

    <div id="TimeOffCalendar" class="tabcontent" style="display:none; flex-direction:column;">
      <div class="calendar-filters">
        <div class="filters">
          <div>
            <h3>Select Management Unit</h3>
            <select id="calendar-management-unit-select">
              <option>Loading…</option>
            </select>
          </div>
          <div>
            <h3>Select Time Off Plan</h3>
            <select id="calendar-plan-select">
              <option>Please select unit first</option>
            </select>
          </div>
          <div>
            <h3>Select Month</h3>
            <select id="calendar-month-select" onchange="updateCalendar()"></select>
          </div>
          <div>
            <h3>Select Year</h3>
            <select id="calendar-year-select" onchange="updateCalendar()"></select>
          </div>
        </div>
      </div>
      <div id="calendar" class="calendar"></div>
    </div>
  </div>

  <script>
    // ==== OAuth Configuration ====
    const CLIENT_ID     = '4652c8b5-9117-43c6-8e54-77eeb38aebb8';
    const CLIENT_SECRET = 'txtfN6cb699Lu7tID5n2NSjGwKOU_6NzyghgSk-bVkY';
    const REGION        = 'mypurecloud.ie';
    const REDIRECT_URI  = 'https://gmcglynn88.github.io/IPI-changes-on-the-fly/';
    const AUTH_URL      = `https://login.${REGION}/oauth/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;

    let accessToken = null;

    // Parse token from URL hash (after redirect)
    function parseTokenFromHash() {
      const hash = window.location.hash.substr(1).split('&')
                    .reduce((res, item) => {
                      const [k,v] = item.split('=');
                      res[k] = v; return res;
                    }, {});
      if (hash.access_token) {
        accessToken = hash.access_token;
        // remove token from URL for cleanliness
        history.replaceState({}, null, window.location.pathname);
      }
    }

    // Generic fetch wrapper to add Authorization
    function pcFetch(url) {
      return fetch(url, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      }).then(r => {
        if (r.status===401) {
          // token expired or missing
          window.location = AUTH_URL;
        }
        return r.json();
      });
    }

    // ==== Calendar API functions ====
    function fetchManagementUnits() {
      pcFetch(`https://api.${REGION}/api/v2/workforcemanagement/managementunits`)
        .then(data => {
          const sel = document.getElementById('calendar-management-unit-select');
          sel.innerHTML = '<option value="">Please select</option>';
          data.entities.forEach(mu => {
            const o = document.createElement('option');
            o.value = mu.id;
            o.textContent = mu.name;
            sel.appendChild(o);
          });
        })
        .catch(console.error);
    }

    function fetchTimeOffPlans(unitId) {
      pcFetch(`https://api.${REGION}/api/v2/workforcemanagement/managementunits/${unitId}/timeoffplans`)
        .then(data => {
          const sel = document.getElementById('calendar-plan-select');
          sel.innerHTML = '<option value="">Please select</option>';
          data.entities.forEach(plan => {
            const o = document.createElement('option');
            o.value = plan.id;
            o.textContent = plan.name;
            sel.appendChild(o);
          });
        })
        .catch(console.error);
    }

    function fetchPlanBalances(unitId, planId, startDate, endDate) {
      pcFetch(`https://api.${REGION}/api/v2/workforcemanagement/managementunits/${unitId}/timeoffplanbalances?timeOffPlanIds=${planId}&startDate=${startDate}&endDate=${endDate}`)
        .then(data => renderCalendarData(data.entities || []))
        .catch(console.error);
    }

    // ==== Calendar rendering ====
    function initializeCalendar() {
      const monthSel = document.getElementById('calendar-month-select');
      const yearSel  = document.getElementById('calendar-year-select');
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthNames.forEach((m,i) => monthSel.appendChild(new Option(m, i+1)));
      [new Date().getFullYear()-1, new Date().getFullYear(), new Date().getFullYear()+1]
        .forEach(y => yearSel.appendChild(new Option(y,y)));
      monthSel.value = new Date().getMonth()+1;
      yearSel.value  = new Date().getFullYear();

      document.getElementById('calendar-management-unit-select')
        .addEventListener('change', e => {
          if (e.target.value) fetchTimeOffPlans(e.target.value);
        });
      document.getElementById('calendar-plan-select')
        .addEventListener('change', updateCalendar);

      fetchManagementUnits();
    }

    function updateCalendar() {
      const unitId = document.getElementById('calendar-management-unit-select').value;
      const planId = document.getElementById('calendar-plan-select').value;
      const month  = document.getElementById('calendar-month-select').value;
      const year   = document.getElementById('calendar-year-select').value;
      if (!unitId || !planId) return;
      const sd = `${year}-${String(month).padStart(2,'0')}-01`;
      const daysInMonth = new Date(year, month, 0).getDate();
      const ed = `${year}-${String(month).padStart(2,'0')}-${daysInMonth}`;
      fetchPlanBalances(unitId, planId, sd, ed);
    }

    function renderCalendarData(balances) {
      const cal = document.getElementById('calendar');
      cal.innerHTML = '';
      const year  = +document.getElementById('calendar-year-select').value;
      const month = +document.getElementById('calendar-month-select').value;
      const days  = new Date(year, month, 0).getDate();

      for (let d = 1; d <= days; d++) {
        const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayData = balances.find(b => b.date === dateStr) || {};
        const sb = dayData.startingBalance || 0;
        const br = dayData.balance || 0;
        const wl = dayData.waitlist || 0;
        const tile = document.createElement('div');
        tile.className = 'day';

        const ratio = sb ? br / sb : 0;
        if (br === 0)          tile.style.background = 'var(--full-color)';
        else if (ratio < 0.1)  tile.style.background = 'var(--nearly-color)';
        else                   tile.style.background = 'var(--available-color)';

        tile.innerHTML = `
          <div class="date">${d}</div>
          <div class="balance-info">
            <div>Start: ${sb}</div>
            <div>Remain: ${br}</div>
            ${wl ? `<div>Wait: ${wl}</div>` : ''}
          </div>
        `;
        cal.appendChild(tile);
      }
    }

    // ==== On load ====
    window.onload = function() {
      parseTokenFromHash();
      if (!accessToken) {
        // kick off OAuth dance
        window.location = AUTH_URL;
      }
      document.getElementById("defaultOpen").click();
      updateTables();         // your existing table init
      initializeCalculator(); // your existing calc init
      initializeCalendar();   // new calendar init
    };
  </script>
</body>
</html>
