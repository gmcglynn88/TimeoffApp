<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Time by IPI</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Proxima Nova', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #63AB8F; /* Custom Teal */
            color: white;
        }

        header h1 {
            margin: 0;
        }

        .logo {
            height: 50px;
            background-color: transparent;
        }

        .divider {
            border: none;
            height: 1px;
            background-color: #ddd;
            margin: 0;
        }

        .content-container {
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th {
            background-color: #63AB8F; /* Custom Teal */
            color: white;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        .export-button {
            padding: 10px 20px;
            background-color: #63AB8F;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Your Time by IPI</h1>
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="Consulting Logo" class="logo">
    </header>

    <hr class="divider">

    <div class="content-container">
        <h3>Time Off Balances</h3>
        <table id="balances-table">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Name</th>
                    <th>TOIL</th>
                    <th>Holiday Balance (Current Year)</th>
                    <th>Holiday Balance (Next Year)</th>
                    <th>Wage ID</th>
                    <th>Contract Hours</th>
                    <th>Management Unit</th>
                    <th>Work Team</th>
                </tr>
            </thead>
            <tbody id="balances-table-body">
                <!-- Data rows will be inserted here dynamically -->
            </tbody>
        </table>
        <button class="export-button" onclick="exportTableToCSV('balances-table', 'time_off_balances.csv')">Export Time Off Balances</button>
    </div>

    <script>
        async function fetchData() {
            const clientId = '80d7c7c9-600e-478e-8d41-1bfb7b8c6bc1'; // Your Client ID
            const clientSecret = 'BQQBxTIiCO-mY1RFm9TL0NcmhtRewKlqozD0GUdiMdE'; // Your Client Secret
            const authUrl = 'https://auth.mypurecloud.ie/oauth/token'; // Authorization endpoint

            try {
                console.log('Requesting access token...'); // Debugging log
                // Step 1: Obtain access token
                const tokenResponse = await fetch(authUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'client_credentials',
                        client_id: clientId,
                        client_secret: clientSecret
                    })
                });

                if (!tokenResponse.ok) {
                    console.error('Failed to fetch access token', tokenResponse.status, tokenResponse.statusText); // Debugging log
                    throw new Error('Failed to fetch access token');
                }

                const tokenData = await tokenResponse.json();
                console.log('Access token received:', tokenData); // Debugging log
                const accessToken = tokenData.access_token;

                // Step 2: Fetch data using the access token
                console.log('Fetching data from API...'); // Debugging log
                const response = await fetch('https://api.mypurecloud.ie/api/v2/flows/datatables/3bcf89ba-8aed-4fdb-b143-a726c3887a27/rows?showbrief=false', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Network response was not ok', response.status, response.statusText); // Debugging log
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('Data fetched from API:', data); // Debugging log
                return data;
            } catch (error) {
                console.error('Error fetching data:', error); // Debugging log
            }
        }

        async function updateTable() {
            const data = await fetchData();

            const balancesTableBody = document.getElementById('balances-table-body');
            balancesTableBody.innerHTML = ''; // Clear existing rows

            if (data && data.entities) {
                console.log('Populating table with data...'); // Debugging log
                data.entities.forEach(row => {
                    const tableRow = document.createElement('tr');
                    tableRow.innerHTML = `
                        <td>${row.key}</td>
                        <td>${row.Name}</td>
                        <td>${row.TOIL}</td>
                        <td>${row['Remaining Holiday Balance (Current Year)']}</td>
                        <td>${row['Remaining Holiday Balance (Next Year)']}</td>
                        <td>${row['Wage ID']}</td>
                        <td>${row['Contract Hours']}</td>
                        <td>${row['Management Unit']}</td>
                        <td>${row['Work Team']}</td>
                    `;
                    balancesTableBody.appendChild(tableRow);
                });
            } else {
                console.log('No data entities found or data is empty'); // Debugging log
            }
        }

        function exportTableToCSV(tableID, filename) {
            var csv = [];
            var rows = document.querySelectorAll(`#${tableID} tr`);

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll("td, th");

                for (var j = 0; j < cols.length; j++) {
                    row.push(cols[j].innerText);
                }

                csv.push(row.join(","));
            }

            // Create a CSV file and download it
            var csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
            var downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        document.addEventListener('DOMContentLoaded', updateTable); // Fetch and display data on page load
    </script>
</body>
</html>
