<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Time by IPI</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Proxima Nova', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #63AB8F;
            color: white;
        }

        header h1 {
            margin: 0;
        }

        .logo {
            height: 50px;
            background-color: transparent;
        }

        .divider {
            border: none;
            height: 1px;
            background-color: #ddd;
            margin: 0;
        }

        .tab-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            padding: 0;
            margin: 0;
        }

        .tab {
            display: flex;
            overflow: hidden;
        }

        .tab button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            margin: 0;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #63AB8F;
            color: white;
        }

        .button-container {
            display: flex;
            gap: 10px;
        }

        .save-button, .import-button-label {
            padding: 10px 20px;
            background-color: #63AB8F;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .import-button-label input {
            display: none;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .tabcontent table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .tabcontent table, th, td {
            border: 1px solid #ddd;
        }

        .tabcontent th {
            background-color: #63AB8F;
            color: white;
        }

        .tabcontent th, .tabcontent td {
            padding: 10px;
            text-align: left;
        }

        .tabcontent label {
            display: block;
            margin-top: 10px;
        }

        .tabcontent select, .tabcontent textarea, .tabcontent input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .tabcontent textarea {
            height: 100px;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: space-between;
        }

        .filters > div {
            flex: 1;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-container label {
            margin-left: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .export-button {
            padding: 10px 20px;
            background-color: #63AB8F;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .negative {
            background-color: pink;
            color: red;
        }

        .search-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .search-container input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }

        .filters div h3 {
            margin-bottom: 5px;
        }

        /* Annual Leave Calculator Specific Styles */
        .calculator-input {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .calculator-input input[type="number"] {
            width: calc(100% - 24px);
            padding: 8px 12px;
        }
        
        .percent-input {
            position: relative;
        }
        
        .percent-input:after {
            content: "%";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #555;
        }
        
        .editable {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
        }
        
        .calculation {
            background-color: #e9f7ef;
            border: 1px solid #63AB8F;
            border-radius: 4px;
            padding: 8px 12px;
        }
        
        .month-allocation-input {
            width: 50px;
            text-align: center;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .result {
            font-weight: bold;
            color: #2c3e50;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .notes-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .notes-section ul {
            padding-left: 20px;
        }

        .notes-section li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Your Time by IPI</h1>
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="Consulting Logo" class="logo">
    </header>

    <hr class="divider">

    <div class="tab-container">
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Settings')" id="defaultOpen">Settings</button>
            <button class="tablinks" onclick="openTab(event, 'TimeOffBalances')">Time Off Balances</button>
            <button class="tablinks" onclick="openTab(event, 'AnnualLeaveCalculator')">Annual Leave Calculator</button>
        </div>
        <div class="button-container">
            <label class="import-button-label">
                Import Balances
                <input type="file" id="import-file" accept=".csv" onchange="importTableFromCSV(event)">
            </label>
            <button class="save-button" onclick="saveChanges()">Save</button>
        </div>
    </div>

    <div id="Settings" class="tabcontent">
        <h3>Settings</h3>
        <label for="holiday-year">Holiday Year:</label>
        <select id="holiday-year">
            <option value="1">Please Select</option>
            <option value="2">1st Jan - 31st Dec</option>
            <option value="3">1st April - 31st Mar</option>
            <option value="4">Other</option>
        </select>
        
        <label>Please list WFM time off codes to be included: (These should be agent selectable codes ONLY)</label>
        <div class="checkbox-container">
            <input type="checkbox" id="holiday" name="time-off-codes" value="Holiday">
            <label for="holiday">Holiday</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="emergency-holiday" name="time-off-codes" value="Emergency Holiday">
            <label for="emergency-holiday">Emergency Holiday</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="toil" name="time-off-codes" value="TOIL">
            <label for="toil">TOIL</label>
        </div>
        
        <label for="bus">Please list Business Units that require integration:</label>
        <textarea id="bus"></textarea>
        
        <label for="data-tables-required">Do you require separate time off Data Tables for the above Business Units?</label>
        <select id="data-tables-required">
            <option value="Selection">Please Select</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>
        
        <label for="num-ttables"> How many tables are required, please select:</label>
        <select id="num-tables">
            <option value="1">Please Select</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
    </div>

    <div id="TimeOffBalances" class="tabcontent">
        <div class="filters">
            <div>
                <h3>Select Agent</h3>
                <select id="agent-select" onchange="updateTables()">
                    <option value="Select" selected>Please Select</option>
                    <option value="all">Select All</option>
                    <option value="Craig Farley">Craig Farley</option>
                    <option value="Sasha Smith">Sasha Smith</option>
                    <option value="Lisa Lowe">Lisa Lowe</option>
                    <option value="Sian Gibbs">Sian Gibbs</option>
                    <option value="John Thompson">John Thompson</option>
                    <option value="Olivia Jenson">Olivia Jenson</option>
                    <option value="Ethan Reynolds">Ethan Reynolds</option>
                    <option value="Ava Mitchell">Ava Mitchell</option>
                    <option value="Gerard McGlynn">Gerard McGlynn</option>
                    <option value="Rhys Turner">Rhys Turner</option>
                    <option value="Tom Collins">Tom Collins</option>
                </select>
            </div>
            <div>
                <h3>Select Year</h3>
                <select id="year-select" onchange="updateTables()">
                    <option value="Select" selected>Please Select</option>
                    <option value="all">Select All</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            <div>
                <h3>Select Management Unit</h3>
                <select id="management-unit-select" onchange="updateTables()">
                    <option value="Select" selected>Please Select</option>
                    <option value="all">Select All</option>
                    <option value="Customer Service">Customer Service</option>
                    <option value="Sales & Retentions">Sales & Retentions</option>
                </select>
            </div>
            <div>
                <h3>Select Work Team</h3>
                <select id="team-select" onchange="updateTables()">
                    <option value="Select" selected>Please Select</option>
                    <option value="all">Select All</option>
                    <option value="Sales & Retentions">Sales & Retentions</option>
                    <option value="Team Reading">Team Reading</option>
                    <option value="Team Sheffield">Team Sheffield</option>
                    <option value="Team Manchester">Team Manchester</option>
                    <option value="Customer Service 2">Customer Service 2</option>
                </select>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search by agent name" onkeyup="filterTables()">
        </div>

        <h3>Time off Balances</h3>
        <table id="balances-table">
            <thead>
                <tr>
                    <th>Agent Name</th>
                    <th>Team</th>
                    <th>Management Unit</th>
                    <th>Holiday (Current Year)</th>
                    <th>Holiday (Next Year)</th>
                    <th>Time off In Lieu</th>
                </tr>
            </thead>
            <tbody id="balances-table-body">
                <!-- Data rows go here -->
            </tbody>
        </table>
        <div class="export-buttons">
            <button class="export-button" onclick="exportTableToCSV('balances-table', 'time_off_balances.csv')">Export Time Off Balances</button>
        </div>

        <h3>Time off Details</h3>
        <table id="details-table">
            <thead>
                <tr>
                    <th>Agent Name</th>
                    <th>Team</th>
                    <th>Management Unit</th>
                    <th>Time off Start</th>
                    <th>Time off End</th>
                    <th>Balance Deduction (Hrs)</th>
                    <th>Days</th>
                </tr>
            </thead>
            <tbody id="details-table-body">
                <!-- Data rows go here -->
            </tbody>
        </table>
        <div class="export-buttons">
            <button class="export-button" onclick="exportTableToCSV('details-table', 'time_off_details.csv')">Export Time Off Details</button>
        </div>
    </div>

    <div id="AnnualLeaveCalculator" class="tabcontent">
        <h2>Annual Leave By Day Calculator</h2>
        
        <div class="calculator-input">
            <div class="input-group">
                <label for="fte-hours">FTE definition (Hours)</label>
                <input type="number" id="fte-hours" class="editable" value="40" min="1">
            </div>
            <div class="input-group">
                <label for="annual-leave-days">Annual Leave Allocation (Days)</label>
                <input type="number" id="annual-leave-days" class="editable" value="33" min="0">
            </div>
            <div class="input-group">
                <label for="agents-count">Agents In Staffing Group</label>
                <input type="number" id="agents-count" class="editable" value="100" min="1">
            </div>
            <div class="input-group">
                <label for="avg-weekly-hours">Average Weekly Hours Per Agent</label>
                <input type="number" id="avg-weekly-hours" class="editable" value="32" min="1" max="40">
            </div>
            <div class="input-group">
                <label for="holiday-percentage">Holiday Weekly Target/Maximum %</label>
                <div class="percent-input">
                    <input type="number" id="holiday-percentage" class="editable" step="0.1" value="14" min="0" max="100">
                </div>
            </div>
        </div>

        <h3>Calculations</h3>
        <div class="calculator-input">
            <div class="input-group">
                <label>FTE Annual Leave (Hours)</label>
                <div class="result calculation" id="fte-annual-leave"></div>
            </div>
            <div class="input-group">
                <label>Minimum Annual Leave Allocation</label>
                <div class="result calculation" id="min-annual-leave"></div>
            </div>
            <div class="input-group">
                <label>Weekly Holiday Allocation Hours</label>
                <div class="result calculation" id="weekly-holiday-hours"></div>
            </div>
            <div class="input-group">
                <label>Contracted Hours</label>
                <div class="result calculation" id="contracted-hours"></div>
            </div>
        </div>

        <h3>Day Of Week Staffing Distribution</h3>
        <table>
            <thead>
                <tr>
                    <th>Day</th>
                    <th>%</th>
                    <th>Hours</th>
                </tr>
            </thead>
            <tbody id="day-distribution">
                <tr>
                    <td>Mon</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="mon-percent" class="editable" step="0.1" value="20" min="0" max="100">
                        </div>
                    </td>
                    <td id="mon-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Tue</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="tue-percent" class="editable" step="0.1" value="17" min="0" max="100">
                        </div>
                    </td>
                    <td id="tue-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Wed</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="wed-percent" class="editable" step="0.1" value="16" min="0" max="100">
                        </div>
                    </td>
                    <td id="wed-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Thu</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="thu-percent" class="editable" step="0.1" value="15" min="0" max="100">
                        </div>
                    </td>
                    <td id="thu-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Fri</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="fri-percent" class="editable" step="0.1" value="14" min="0" max="100">
                        </div>
                    </td>
                    <td id="fri-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Sat</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="sat-percent" class="editable" step="0.1" value="10" min="0" max="100">
                        </div>
                    </td>
                    <td id="sat-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td>Sun</td>
                    <td>
                        <div class="percent-input">
                            <input type="number" id="sun-percent" class="editable" step="0.1" value="8" min="0" max="100">
                        </div>
                    </td>
                    <td id="sun-hours" class="calculation"></td>
                </tr>
                <tr>
                    <td><strong>Total</strong></td>
                    <td id="total-percent" class="calculation"></td>
                    <td id="total-hours" class="calculation"></td>
                </tr>
            </tbody>
        </table>

        <h3>Daily Allocation By Month</h3>
        <table>
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Allocation %</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                    <th>Sun</th>
                </tr>
            </thead>
            <tbody id="month-allocation">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>

        <h3>Summary</h3>
        <div class="calculator-input">
            <div class="input-group">
                <label>Allocated Hours</label>
                <div class="result calculation" id="allocated-hours"></div>
            </div>
            <div class="input-group">
                <label>Allocated %</label>
                <div class="result calculation" id="allocated-percent"></div>
            </div>
            <div class="input-group">
                <label>Margin</label>
                <div class="result calculation" id="margin"></div>
            </div>
        </div>

        <div class="notes-section">
            <h3>Notes</h3>
            <ul>
                <li>Should we build something to vary for seasonality in staffing numbers?</li>
                <li>Can we calculate the agents in staffing group / average hours per agent / staffing distribution from data in Genesys?</li>
                <li>How can we ensure users don't accidentally put standard allowances in for special days?</li>
                <li>Could change the "Holiday Weekly Target/Maximum %" field to be "Annual Vacation Hours Per FTE" or something (to stop underestimations of leave required).</li>
                <li>Or, for previous point, could add those in as optional fields to allow users to sense check their numbers (added to calculator!)</li>
                <li>Could potentially have an option to specify different weekly/daily targets by month or week, depending how far you want to go with it (added to calculator!)</li>
            </ul>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        document.getElementById("defaultOpen").click();

        const balancesData = {
            "Craig Farley": [
                {
                    agentName: 'Craig Farley',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    holidayCurrentYear: 10,
                    holidayNextYear: 190,
                    timeOffInLieu: -3
                }
            ],
            "Sasha Smith": [
                {
                    agentName: 'Sasha Smith',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    holidayCurrentYear: 1.5,
                    holidayNextYear: 50,
                    timeOffInLieu: 2
                }
            ],
            "Lisa Lowe": [
                {
                    agentName: 'Lisa Lowe',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 42,
                    holidayNextYear: 237,
                    timeOffInLieu: -10
                }
            ],
            "Sian Gibbs": [
                {
                    agentName: 'Sian Gibbs',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 87,
                    holidayNextYear: 237,
                    timeOffInLieu: 0
                }
            ],
            "John Thompson": [
                {
                    agentName: 'John Thompson',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 41,
                    holidayNextYear: 186,
                    timeOffInLieu: 10
                }
            ],
            "Olivia Jenson": [
                {
                    agentName: 'Olivia Jenson',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    holidayCurrentYear: 65,
                    holidayNextYear: 237,
                    timeOffInLieu: 3.25
                }
            ],
            "Ethan Reynolds": [
                {
                    agentName: 'Ethan Reynolds',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 109,
                    holidayNextYear: 237,
                    timeOffInLieu: 0
                }
            ],
            "Ava Mitchell": [
                {
                    agentName: 'Ava Mitchell',
                    team: 'Team Sheffield',
                    managementUnit: 'Sales & Retentions',
                    holidayCurrentYear: 234,
                    holidayNextYear: 237,
                    timeOffInLieu: -4
                }
            ],
            "Gerard McGlynn": [
                {
                    agentName: 'Gerard McGlynn',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 128,
                    holidayNextYear: 237,
                    timeOffInLieu: 24
                }
            ],
            "Tom Collins": [
                {
                    agentName: 'Tom Collins',
                    team: 'Team Reading',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 10,
                    holidayNextYear: 154,
                    timeOffInLieu: 2
                }
            ],
            "Rhys Turner": [
                {
                    agentName: 'Rhys Turner',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    holidayCurrentYear: 28,
                    holidayNextYear: 237,
                    timeOffInLieu: 4
                }
            ]                            
        };

        const detailsData = {
            "Craig Farley": [
                {
                    agentName: 'Craig Farley',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    timeOffStart: '01/01/2024',
                    timeOffEnd: '01/01/2024',
                    balanceDeduction: 8,
                }
            ],
            "Sasha Smith": [
                {
                    agentName: 'Sasha Smith',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    timeOffStart: '01/02/2025',
                    timeOffEnd: '01/02/2025',
                    balanceDeduction: 8,
                }
            ],
            "Lisa Lowe": [
                {
                    agentName: 'Lisa Lowe',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/03/2024',
                    timeOffEnd: '01/03/2024',
                    balanceDeduction: 4.25,
                }
            ],
            "Sian Gibbs": [
                {
                    agentName: 'Sian Gibbs',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/04/2024',
                    timeOffEnd: '03/04/2024',
                    balanceDeduction: 24,
                }
            ],
            "John Thompson": [
                {
                    agentName: 'John Thompson',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/05/2024',
                    timeOffEnd: '04/05/2024',
                    balanceDeduction: 32,
                }
            ],
            "Olivia Jenson": [
                {
                    agentName: 'Olivia Jenson',
                    team: 'Team Reading',
                    managementUnit: 'Sales & Retentions',
                    timeOffStart: '01/06/2024',
                    timeOffEnd: '07/06/2024',
                    balanceDeduction: 40,
                }
            ],
            "Ethan Reynolds": [
                {
                    agentName: 'Ethan Reynolds',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/07/2024',
                    timeOffEnd: '01/07/2024',
                    balanceDeduction: 8,
                }
            ],
            "Ava Mitchell": [
                {
                    agentName: 'Ava Mitchell',
                    team: 'Team Sheffield',
                    managementUnit: 'Sales & Retentions',
                    timeOffStart: '01/08/2024',
                    timeOffEnd: '01/08/2024',
                    balanceDeduction: 8,
                }
            ],
            "Gerard McGlynn": [
                {
                    agentName: 'Gerard McGlynn',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/07/2025',
                    timeOffEnd: '01/07/2025',
                    balanceDeduction: 8,
                },
                {
                    agentName: 'Gerard McGlynn',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/09/2024',
                    timeOffEnd: '07/09/2024',
                    balanceDeduction: 40,
                },
                {
                    agentName: 'Gerard McGlynn',
                    team: 'Team Sheffield',
                    managementUnit: 'Customer Service',
                    timeOffStart: '12/10/2025',
                    timeOffEnd: '14/10/2025',
                    balanceDeduction: 16,
                }
            ],
            "Rhys Turner": [
                {
                    agentName: 'Rhys Turner',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/10/2025',
                    timeOffEnd: '01/10/2025',
                    balanceDeduction: 8,
                },
                {
                    agentName: 'Rhys Turner',
                    team: 'Team Manchester',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/09/2024',
                    timeOffEnd: '06/09/2024',
                    balanceDeduction: 32,
                }
            ],
            "Tom Collins": [
                {
                    agentName: 'Tom Collins',
                    team: 'Team Reading',
                    managementUnit: 'Customer Service',
                    timeOffStart: '01/10/2024',
                    timeOffEnd: '01/10/2024',
                    balanceDeduction: 8,
                }
            ]
        };

        function updateTables() {
            const selectedAgent = document.getElementById('agent-select').value;
            const selectedYear = document.getElementById('year-select').value;
            const selectedManagementUnit = document.getElementById('management-unit-select').value;
            const selectedTeam = document.getElementById('team-select').value;

            const balancesTableBody = document.getElementById('balances-table-body');
            const detailsTableBody = document.getElementById('details-table-body');

            // Clear existing rows
            balancesTableBody.innerHTML = '';
            detailsTableBody.innerHTML = '';

            let allBalancesData = [];
            let allDetailsData = [];

            if (selectedAgent === 'all') {
                // Aggregate data for all agents
                for (let agent in balancesData) {
                    let agentData = localStorage.getItem('balancesData-' + agent);
                    if (agentData) {
                        agentData = JSON.parse(agentData);
                    } else {
                        agentData = balancesData[agent];
                    }
                    allBalancesData = allBalancesData.concat(agentData);
                }

                for (let agent in detailsData) {
                    allDetailsData = allDetailsData.concat(detailsData[agent]);
                }
            } else {
                let agentData = localStorage.getItem('balancesData-' + selectedAgent);
                if (agentData) {
                    agentData = JSON.parse(agentData);
                } else {
                    agentData = balancesData[selectedAgent] || [];
                }
                allBalancesData = agentData;
                allDetailsData = detailsData[selectedAgent] || [];
            }

            // Filter by management unit
            if (selectedManagementUnit !== 'all') {
                allBalancesData = allBalancesData.filter(data => data.managementUnit === selectedManagementUnit);
                allDetailsData = allDetailsData.filter(data => data.managementUnit === selectedManagementUnit);
            }

            // Filter by team
            if (selectedTeam !== 'all') {
                allBalancesData = allBalancesData.filter(data => data.team === selectedTeam);
                allDetailsData = allDetailsData.filter(data => data.team === selectedTeam);
            }

            // Filter by year
            allDetailsData = allDetailsData.filter(data => {
                const startDate = new Date(data.timeOffStart);
                const endDate = new Date(data.timeOffEnd);
                return selectedYear === 'all' || startDate.getFullYear() == selectedYear || endDate.getFullYear() == selectedYear;
            });

            // Populate the balances table with editable fields
            allBalancesData.forEach(data => {
                const row = document.createElement('tr');
                Object.keys(data).forEach(key => {
                    const cell = document.createElement('td');
                    if (key === 'holidayCurrentYear' || key === 'holidayNextYear' || key === 'timeOffInLieu') {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = data[key];
                        if (key === 'timeOffInLieu' && data[key] < 0) {
                            input.classList.add('negative');
                        }
                        cell.appendChild(input);
                    } else {
                        cell.textContent = data[key];
                    }
                    row.appendChild(cell);
                });
                balancesTableBody.appendChild(row);
            });

            // Populate the details table
            allDetailsData.forEach(data => {
                const row = document.createElement('tr');
                Object.values(data).forEach((value, index) => {
                    const cell = document.createElement('td');
                    cell.textContent = value;
                    row.appendChild(cell);
                    if (index === 5) { // After balanceDeduction cell, add Days cell
                        const daysCell = document.createElement('td');
                        daysCell.textContent = (value / 8).toFixed(1); // Assuming 8 hours per day
                        row.appendChild(daysCell);
                    }
                });
                detailsTableBody.appendChild(row);
            });
        }

        function saveChanges() {
            const selectedAgent = document.getElementById('agent-select').value;
            const balancesTableBody = document.getElementById('balances-table-body');
            const balancesRows = balancesTableBody.getElementsByTagName('tr');
            let balancesData = [];

            for (let row of balancesRows) {
                let cells = row.getElementsByTagName('td');
                balancesData.push({
                    agentName: cells[0].textContent,
                    team: cells[1].textContent,
                    managementUnit: cells[2].textContent,
                    holidayCurrentYear: cells[3].getElementsByTagName('input')[0].value,
                    holidayNextYear: cells[4].getElementsByTagName('input')[0].value,
                    timeOffInLieu: cells[5].getElementsByTagName('input')[0].value
                });
            }

            // Save to local storage
            if (selectedAgent !== 'all') {
                localStorage.setItem('balancesData-' + selectedAgent, JSON.stringify(balancesData));
            } else {
                for (let agent in balancesData) {
                    let agentData = balancesData.filter(data => data.agentName === agent);
                    localStorage.setItem('balancesData-' + agent, JSON.stringify(agentData));
                }
            }

            alert('Changes saved successfully!');
        }

        function exportTableToCSV(tableID, filename) {
            var csv = [];
            var rows = document.querySelectorAll(`#${tableID} tr`);

            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll("td, th");

                for (var j = 0; j < cols.length; j++) {
                    if (cols[j].querySelector('input')) {
                        row.push(cols[j].querySelector('input').value);
                    } else {
                        row.push(cols[j].innerText);
                    }
                }

                csv.push(row.join(","));
            }

            // Create a CSV file and download it
            var csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
            var downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function importTableFromCSV(event) {
            const input = event.target;
            const reader = new FileReader();
            reader.onload = function() {
                const csv = reader.result;
                const rows = csv.split("\n").map(row => row.split(","));
                const balancesTableBody = document.getElementById('balances-table-body');

                balancesTableBody.innerHTML = '';

                rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header row

                    const tr = document.createElement('tr');
                    row.forEach((cell, cellIndex) => {
                        const td = document.createElement('td');
                        if (cellIndex > 2) { // For columns with input fields
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = cell.trim();
                            if (cellIndex === 5 && input.value < 0) {
                                input.classList.add('negative');
                            }
                            td.appendChild(input);
                        } else {
                            td.textContent = cell.trim();
                        }
                        tr.appendChild(td);
                    });
                    balancesTableBody.appendChild(tr);
                });
            };
            reader.readAsText(input.files[0]);
        }

        function filterTables() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const balancesTableBody = document.getElementById('balances-table-body');
            const detailsTableBody = document.getElementById('details-table-body');

            const filterTable = (tableBody) => {
                const rows = tableBody.getElementsByTagName('tr');
                for (let row of rows) {
                    const agentNameCell = row.getElementsByTagName('td')[0];
                    const agentName = agentNameCell.textContent.toLowerCase();
                    if (agentName.includes(searchInput)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            };

            filterTable(balancesTableBody);
            filterTable(detailsTableBody);
        }

        // Annual Leave Calculator Functions
        const monthlyAllocations = [
            { month: 'Jan', allocation: 10 },
            { month: 'Feb', allocation: 12 },
            { month: 'Mar', allocation: 14 },
            { month: 'Apr', allocation: 14 },
            { month: 'May', allocation: 12 },
            { month: 'Jun', allocation: 10 },
            { month: 'Jul', allocation: 16 },
            { month: 'Aug', allocation: 18 },
            { month: 'Sep', allocation: 10 },
            { month: 'Oct', allocation: 8 },
            { month: 'Nov', allocation: 8 },
            { month: 'Dec', allocation: 25 }
        ];

        function calculateAnnualLeave() {
            // Get input values
            const fteHours = parseFloat(document.getElementById('fte-hours').value) || 40;
            const annualLeaveDays = parseFloat(document.getElementById('annual-leave-days').value) || 33;
            const agentsCount = parseFloat(document.getElementById('agents-count').value) || 100;
            const avgWeeklyHours = parseFloat(document.getElementById('avg-weekly-hours').value) || 32;
            const holidayPercentage = (parseFloat(document.getElementById('holiday-percentage').value) || 14) / 100;

            // Calculate key metrics
            const fteAnnualLeave = (fteHours / 5) * annualLeaveDays;
            const minAnnualLeave = fteAnnualLeave / (fteHours * 52);
            const weeklyHolidayHours = (agentsCount * avgWeeklyHours) * holidayPercentage;
            const contractedHours = (avgWeeklyHours * agentsCount) * 52;

            // Update calculated fields
            document.getElementById('fte-annual-leave').textContent = fteAnnualLeave.toFixed(2) + " hrs";
            document.getElementById('min-annual-leave').textContent = (minAnnualLeave * 100).toFixed(2) + "%";
            document.getElementById('weekly-holiday-hours').textContent = weeklyHolidayHours.toFixed(2) + " hrs";
            document.getElementById('contracted-hours').textContent = contractedHours.toFixed(2) + " hrs";

            // Calculate day distribution
            let totalPercent = 0;
            let totalHours = 0;
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            days.forEach(day => {
                const percent = parseFloat(document.getElementById(`${day}-percent`).value) || 0;
                totalPercent += percent;
                const hours = Math.round((percent / 100) * weeklyHolidayHours);
                document.getElementById(`${day}-hours`).textContent = hours + " hrs";
            });

            document.getElementById('total-percent').textContent = totalPercent.toFixed(1) + "%";
            document.getElementById('total-hours').textContent = Math.round(weeklyHolidayHours) + " hrs";

            // Calculate monthly allocations
            const monthTable = document.getElementById('month-allocation');
            monthTable.innerHTML = '';
            
            let totalAllocatedHours = 0;
            
            monthlyAllocations.forEach(monthData => {
                const row = document.createElement('tr');
                
                // Month column
                const monthCell = document.createElement('td');
                monthCell.textContent = monthData.month;
                row.appendChild(monthCell);
                
                // Allocation column (editable)
                const allocCell = document.createElement('td');
                const allocInput = document.createElement('input');
                allocInput.type = 'number';
                allocInput.className = 'month-allocation-input editable';
                allocInput.value = monthData.allocation;
                allocInput.min = 0;
                allocInput.max = 100;
                allocInput.step = 0.1;
                allocInput.dataset.month = monthData.month;
                allocInput.addEventListener('change', calculateAnnualLeave);
                allocInput.addEventListener('input', calculateAnnualLeave);
                
                const allocWrapper = document.createElement('div');
                allocWrapper.className = 'percent-input';
                allocWrapper.appendChild(allocInput);
                allocCell.appendChild(allocWrapper);
                row.appendChild(allocCell);
                
                // Daily allocations for each day of week
                days.forEach(day => {
                    const dayPercent = (parseFloat(document.getElementById(`${day}-percent`).value) || 0) / 100;
                    const monthAlloc = (parseFloat(allocInput.value) || 0) / 100;
                    const allocation = Math.round(dayPercent * (agentsCount * avgWeeklyHours) * monthAlloc);
                    
                    const dayCell = document.createElement('td');
                    dayCell.textContent = allocation;
                    dayCell.className = 'calculation';
                    row.appendChild(dayCell);
                    
                    // Add to total allocated hours (sum of all days, then multiplied by 52/12)
                    totalAllocatedHours += allocation;
                });
                
                monthTable.appendChild(row);
            });

            // Calculate summary metrics
            const allocatedHours = totalAllocatedHours * (52/12);
            const allocatedPercent = allocatedHours / contractedHours;
            const margin = (allocatedPercent - minAnnualLeave) * 100; // Convert to percentage

            document.getElementById('allocated-hours').textContent = allocatedHours.toFixed(2) + " hrs";
            document.getElementById('allocated-percent').textContent = (allocatedPercent * 100).toFixed(2) + "%";
            document.getElementById('margin').textContent = margin.toFixed(2) + "%";
        }

        // Set up event listeners for all calculator inputs
        document.querySelectorAll('#AnnualLeaveCalculator input').forEach(input => {
            input.addEventListener('change', calculateAnnualLeave);
            input.addEventListener('input', calculateAnnualLeave);
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            updateTables();
            calculateAnnualLeave();
        });
    </script>
</body>
</html>
