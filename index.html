<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Time by IPI</title>
  <link href="https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-color:#63AB8F;--secondary-color:#4A8C7D;--border-color:#DEE2E6;--light-bg:#F8F9FA;
      --card-bg:#FFFFFF;--text-color:#2C3E50;--text-light:#6C757D;--available-color:#c8e6c9;
      --nearly-color:#ffe0b2;--full-color:#ffcdd2;
    }
    *{box-sizing:border-box}
    body{font-family:'Aptos',Arial,sans-serif;margin:0;background:var(--light-bg);color:var(--text-color);min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:var(--primary-color);color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-logo,.logo{height:40px;object-fit:contain}
    .divider{border:none;height:1px;background:var(--border-color);margin:0}
    .tab-container{display:flex;justify-content:space-between;align-items:center;background:var(--light-bg);border-bottom:1px solid var(--border-color);padding:0 20px}
    .tab{display:flex}
    .tab button{background:transparent;border:none;cursor:pointer;padding:12px 20px;font-size:15px;color:var(--text-light);font-weight:600;border-bottom:3px solid transparent;transition:.3s}
    .tab button:hover{color:var(--primary-color)}
    .tab button.active{color:var(--primary-color);border-bottom:3px solid var(--primary-color)}
    .button-container{display:flex;gap:10px;align-items:center}
    .save-button,.export-button,.import-button-label{padding:8px 16px;background:var(--primary-color);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600;transition:.3s}
    .save-button:hover,.export-button:hover,.import-button-label:hover{background:var(--secondary-color)}
    .import-button-label input{display:none}

    .main-content{flex:1;padding:20px;display:flex;flex-direction:column;overflow:hidden}
    .tabcontent{display:none; /* shown via JS */ flex:1;overflow:hidden;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05)}

    /* Balances tab layout */
    .balances-container{flex:1;display:flex;flex-direction:column;overflow:auto;padding:20px}
    .filters{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
    .filters>div{flex:1;min-width:200px}
    .filters h3{font-size:14px;margin:0 0 8px;color:var(--text-light);font-weight:600}
    .filters select{width:100%;padding:8px 12px;border:1px solid var(--border-color);border-radius:4px;font-size:14px;background:var(--card-bg)}
    .search-container{margin-bottom:20px}
    .search-container input{width:100%;max-width:400px;padding:8px 12px;border:1px solid var(--border-color);border-radius:4px;font-size:14px}
    .table-container{flex:0 0 auto;overflow:auto;margin:15px 0 20px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg)}
    .table-toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:10px}
    .toolbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .toolbar-right input[type="date"]{padding:6px 8px;border:1px solid var(--border-color);border-radius:4px}
    table{width:100%;border-collapse:collapse;font-size:14px;background:var(--card-bg)}
    th,td{padding:12px 15px;text-align:left;border:1px solid var(--border-color)}
    th{background:var(--primary-color);color:#fff;font-weight:600;position:sticky;top:0}
    tr:nth-child(even){background-color:var(--light-bg)}
    tr:hover{background-color:rgba(99,171,143,.1)}
    .balance-input{width:100%;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--card-bg);font-size:14px;transition:background .15s,border-color .15s,color .15s}

    /* NEW: colour coding for low & negative balances */
    .balance-input.low{background:#FFF4E5;border-color:#FFB74D}
    .balance-input.negative{background:#FFE8E8;border-color:#E57373;color:#C62828}

    /* Calculator */
    #Calculator{padding:20px}
    .calc-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .calc-header h2{font-size:1.3em;margin:0 0 20px;color:var(--primary-color);font-weight:700}
    .flex-container{flex:1;display:flex;gap:20px;overflow:hidden}
    .left-panel,.right-panel{display:flex;flex-direction:column;overflow:hidden}
    .left-panel{flex:0 0 35%}.right-panel{flex:1}
    .panel-section{margin-bottom:20px}
    .section-title{font-weight:600;color:var(--primary-color);margin-bottom:10px;font-size:15px}
    .calc-table{width:100%;border-collapse:collapse;margin-bottom:15px;font-size:14px}
    .calc-table th,.calc-table td{padding:10px 12px;border:1px solid var(--border-color);text-align:left}
    .calc-table th{background:var(--primary-color);color:#fff}
    .input-cell{width:100%;padding:6px 8px;border:1px solid var(--border-color);border-radius:4px;background:var(--light-bg);font-size:14px}
    .calculation-cell{background:rgba(99,171,143,.1);border:1px solid var(--primary-color);border-radius:4px;padding:6px 8px;font-weight:600}
    .monthly-tables-container{display:flex;gap:20px;margin-top:10px}
    .monthly-input-container{flex:0 0 40%}
    .calculate-button{padding:8px 16px;background:var(--primary-color);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600;transition:.3s;margin-top:10px}
    .calculate-button:hover{background:var(--secondary-color)}
    .monthly-results-container{flex:1}

    /* Calendar */
    .calendar-filters .filters{display:flex;gap:15px;flex-wrap:wrap;padding:20px;background:var(--card-bg);border-bottom:1px solid var(--border-color)}
    .calendar-container{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0 20px 20px}
    .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;padding:8px 0;font-weight:bold;text-align:center;background:var(--light-bg)}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:1fr;gap:8px;flex:1;min-height:0}
    .calendar .day{border:1px solid var(--border-color);border-radius:4px;padding:8px 4px 4px;display:flex;flex-direction:column;justify-content:space-between;min-height:80px;transition:background .25s}
    .calendar .day.empty{background-color:var(--light-bg);border:1px dashed var(--border-color)}
    .calendar .day .date{font-weight:600;margin-bottom:6px;font-size:14px}
    .calendar .day .balance-info{font-size:12px;color:var(--text-light);line-height:1.2;margin-bottom:2px}
    .day-input{width:48px;font-size:13px;padding:2px 3px;border:1px solid var(--border-color);border-radius:4px}
    .bulk-update-panel{margin-top:10px;background:#f3f7f4;border-radius:8px;padding:16px}
    .bulk-update-panel label{display:flex;align-items:center;gap:4px;font-size:14px}
    .bulk-update-panel input{font-size:14px;padding:3px 4px;border-radius:4px;border:1px solid var(--border-color)}
    .bulk-update-panel button{margin-left:12px;background:var(--primary-color);color:#fff;padding:8px 18px;border-radius:5px;border:none;cursor:pointer}
    #calendar-save-btn{margin:16px auto 0;display:block;background:var(--primary-color);color:#fff;border:none;padding:10px 28px;border-radius:5px;cursor:pointer;font-size:16px;font-weight:600}
    #calendar-save-btn:active,.bulk-update-panel button:active{background:var(--secondary-color)}

    @media (max-width:1200px){.flex-container{flex-direction:column}.left-panel,.right-panel{min-width:100%}.monthly-tables-container{flex-direction:column}.monthly-input-container,.monthly-results-container{flex:1;width:100%}}
    @media (max-width:900px){.calendar-header,.calendar{font-size:13px}.calendar .day{min-height:60px}}
    @media (max-width:700px){
      .calendar-header,.calendar{font-size:11px}.calendar .day{min-height:40px;padding:4px 1px}
      .calendar-filters .filters{padding:10px;gap:8px}.calendar-container{padding:0 5px 12px}
      .bulk-update-panel{padding:8px}
    }
  </style>
</head>
<body>
  <div id="app-content" style="width:100%;height:100%;flex:1;display:flex;flex-direction:column;">
    <header>
      <div class="brand">
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/Yourtime.png" alt="Your Time" class="brand-logo">
      </div>
      <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/IPI_Primary%20Identity_Corporate_REVERSED_ECC.png" alt="Consulting Logo" class="logo">
    </header>
    <hr class="divider">

    <div class="tab-container">
      <div class="tab">
        <button class="tablinks active" data-tab="TimeOffBalances">Time Off Balances</button>
        <button class="tablinks" data-tab="Calculator">Calculator</button>
        <button class="tablinks" data-tab="TimeOffCalendar">Time Off Calendar</button>
      </div>
      <div class="button-container">
        <label class="import-button-label">Import Balances
          <input type="file" id="import-file" accept=".csv">
        </label>
        <button class="save-button" onclick="alert('Changes saved! (Just a demo)')">Save</button>
      </div>
    </div>

    <div class="main-content">
      <!-- Time Off Balances Tab -->
      <div id="TimeOffBalances" class="tabcontent">
        <div class="balances-container">
          <div class="filters">
            <div>
              <h3>Select Agent</h3>
              <select id="agent-select" onchange="updateTables()">
                <option value="Select">Please Select</option>
                <option value="all">Select All</option>
                <option>Craig Farley</option><option>Sasha Smith</option><option>Lisa Lowe</option>
                <option>Sian Gibbs</option><option>John Thompson</option><option>Olivia Jenson</option>
                <option>Ethan Reynolds</option><option>Ava Mitchell</option><option>Gerard McGlynn</option>
                <option>Rhys Turner</option><option>Tom Collins</option>
              </select>
            </div>
            <div>
              <h3>Select Year</h3>
              <select id="year-select" onchange="updateTables()">
                <option value="Select">Please Select</option>
                <option value="all">Select All</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
              </select>
            </div>
            <div>
              <h3>Select Management Unit</h3>
              <select id="management-unit-select" onchange="updateTables()">
                <option value="Select">Please Select</option>
                <option value="all">Select All</option>
                <option>Customer Service</option>
                <option>Sales & Retentions</option>
              </select>
            </div>
            <div>
              <h3>Select Work Team</h3>
              <select id="team-select" onchange="updateTables()">
                <option value="Select">Please Select</option>
                <option value="all">Select All</option>
                <option>Team Reading</option>
                <option>Team Sheffield</option>
                <option>Team Manchester</option>
                <option>Team London</option>
                <option>Team Nashville</option>
              </select>
            </div>
          </div>

          <div class="search-container">
            <input type="text" id="search-input" placeholder="Search by agent name" onkeyup="filterTables()">
          </div>

          <div class="table-container">
            <div class="table-toolbar">
              <h3 style="margin:0;">Time off Balances</h3>
              <div class="toolbar-right">
                <button class="export-button" type="button" onclick="exportTableToCSV('balances-table','time_off_balances.csv')">Export</button>
              </div>
            </div>
            <table id="balances-table">
              <thead>
                <tr>
                  <th>Agent Name</th><th>Team</th><th>Management Unit</th>
                  <th>Holiday (Current Year)</th><th>Holiday (Next Year)</th><th>Time off In Lieu</th>
                </tr>
              </thead>
              <tbody id="balances-table-body"></tbody>
            </table>
          </div>

          <div class="table-container">
            <div class="table-toolbar">
              <h3 style="margin:0;">Time off Details</h3>
              <div class="toolbar-right">
                <label>From <input type="date" id="details-from"></label>
                <label>To <input type="date" id="details-to"></label>
                <button class="export-button" type="button" onclick="updateTables()">Apply</button>
                <button class="export-button" type="button" onclick="clearDetailsDateRange()">Clear</button>
                <button class="export-button" type="button" onclick="exportTableToCSV('details-table','time_off_details.csv')">Export</button>
              </div>
            </div>

            <div id="details-summary" style="padding:0 10px 8px;color:var(--text-light);font-size:14px;"></div>

            <table id="details-table">
              <thead>
                <tr>
                  <th>Agent Name</th><th>Team</th><th>Management Unit</th>
                  <th>Time off Start</th><th>Time off End</th><th>Balance Deduction (Hrs)</th><th>Days</th>
                </tr>
              </thead>
              <tbody id="details-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Calculator Tab -->
      <div id="Calculator" class="tabcontent">
        <div class="calc-container">
          <div class="calc-header"><h2>Annual Leave By Day Calculator</h2></div>
          <div class="flex-container">
            <div class="left-panel">
              <div class="panel-section">
                <div class="section-title">FTE & Leave Settings</div>
                <table class="calc-table">
                  <tr><th>Variable</th><th>Value</th></tr>
                  <tr><td>FTE definition (Hours)</td><td><input type="number" id="fte-hours" class="input-cell" value="40" min="1"></td></tr>
                  <tr><td>Annual Leave Allocation (Days)</td><td><input type="number" id="annual-leave-days" class="input-cell" value="33" min="0"></td></tr>
                  <tr><td>Working Days per Week</td><td><input type="number" id="working-days" class="input-cell" value="5" min="1" max="7"></td></tr>
                </table>
              </div>
              <div class="panel-section">
                <div class="section-title">Staffing Inputs</div>
                <table class="calc-table">
                  <tr><th>Variable</th><th>Value</th></tr>
                  <tr><td>Agents In Staffing Group</td><td><input type="number" id="agents-count" class="input-cell" value="100" min="1"></td></tr>
                  <tr><td>Average Weekly Hours Per Agent</td><td><input type="number" id="avg-weekly-hours" class="input-cell" value="32" min="1" max="40"></td></tr>
                  <tr><td>Holiday Weekly Target (%)</td><td><input type="number" id="holiday-percentage" class="input-cell" value="14" min="0" max="100"></td></tr>
                </table>
              </div>
              <div class="panel-section">
                <div class="section-title">Weekly Holiday Allocation</div>
                <table class="calc-table">
                  <tr><th>Metric</th><th>Result</th></tr>
                  <tr><td>Weekly Holiday Allocation Hours</td><td id="weekly-holiday-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Daily Holiday Allocation Hours</td><td id="daily-holiday-hours" class="calculation-cell">0.00</td></tr>
                </table>
              </div>
              <div class="panel-section">
                <div class="section-title">Day-of-Week Distribution</div>
                <table class="calc-table" id="day-distribution">
                  <tr><th>Day</th><th>% Distribution</th><th>Hours</th></tr>
                  <tr><td>Mon</td><td><input type="number" id="mon-percent" class="input-cell" value="20"></td><td id="mon-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Tue</td><td><input type="number" id="tue-percent" class="input-cell" value="17"></td><td id="tue-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Wed</td><td><input type="number" id="wed-percent" class="input-cell" value="16"></td><td id="wed-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Thu</td><td><input type="number" id="thu-percent" class="input-cell" value="15"></td><td id="thu-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Fri</td><td><input type="number" id="fri-percent" class="input-cell" value="14"></td><td id="fri-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Sat</td><td><input type="number" id="sat-percent" class="input-cell" value="10"></td><td id="sat-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td>Sun</td><td><input type="number" id="sun-percent" class="input-cell" value="8"></td><td id="sun-hours" class="calculation-cell">0.00</td></tr>
                  <tr><td><strong>Total</strong></td><td id="total-percent" class="calculation-cell">100%</td><td id="total-hours" class="calculation-cell">0.00</td></tr>
                </table>
              </div>
            </div>
            <div class="right-panel">
              <div class="panel-section">
                <div class="section-title">Monthly Allocation</div>
                <div class="monthly-tables-container">
                  <div class="monthly-input-container">
                    <table class="calc-table">
                      <thead><tr><th>Month</th><th>% Distribution</th></tr></thead>
                      <tbody id="monthly-inputs"></tbody>
                    </table>
                    <div id="total-validation" style="margin-top:10px;font-size:14px;color:green;">Total: 100.00% (Valid)</div>
                    <button class="calculate-button" onclick="calculateMonthlyAllocation()">Calculate Monthly Allocation</button>
                  </div>
                  <div class="monthly-results-container">
                    <table class="calc-table">
                      <thead><tr><th>Month</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th><th>Total</th></tr></thead>
                      <tbody id="monthly-results"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /Calculator -->

      <!-- Time Off Calendar Tab -->
      <div id="TimeOffCalendar" class="tabcontent">
        <div class="calendar-filters">
          <div class="filters">
            <div><h3>Select Management Unit</h3><select id="calendar-management-unit-select"><option value="">Customer Service</option><option>Sales & Retentions</option></select></div>
            <div><h3>Select Time Off Plan</h3><select id="calendar-plan-select"><option value="">Holiday Plan</option><option>Sick</option></select></div>
            <div><h3>Select Time Off Limit</h3><select id="calendar-limit-select"><option value="">Team A Limit</option><option>Team B</option></select></div>
            <div><h3>Select Month</h3><select id="calendar-month-select"></select></div>
            <div><h3>Select Year</h3><select id="calendar-year-select"></select></div>
          </div>
          <div class="bulk-update-panel">
            <strong>Bulk update by weekday:</strong>
            <div style="display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;">
              <label>Mon <input type="number" class="bulk-input" data-weekday="1" style="width:60px;"></label>
              <label>Tue <input type="number" class="bulk-input" data-weekday="2" style="width:60px;"></label>
              <label>Wed <input type="number" class="bulk-input" data-weekday="3" style="width:60px;"></label>
              <label>Thu <input type="number" class="bulk-input" data-weekday="4" style="width:60px;"></label>
              <label>Fri <input type="number" class="bulk-input" data-weekday="5" style="width:60px;"></label>
              <label>Sat <input type="number" class="bulk-input" data-weekday="6" style="width:60px;"></label>
              <label>Sun <input type="number" class="bulk-input" data-weekday="0" style="width:60px;"></label>
              <button type="button" id="bulk-apply-btn">Bulk Apply</button>
            </div>
            <div style="color:#888;font-size:13px;">Set a value for a weekday and hit 'Bulk Apply' to update all those days in this month.</div>
          </div>
        </div>
        <div class="calendar-container">
          <div class="calendar-header"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
          <div id="calendar" class="calendar"></div>
          <button id="calendar-save-btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------- Balances (your latest list) --------
    const sampleBalances = [
      { name:"Craig Farley",  team:"Team Reading",   unit:"Customer Service",     holidayCurrent:120, holidayNext:80,  toil:-15 },
      { name:"Sasha Smith",   team:"Team Sheffield", unit:"Customer Service",     holidayCurrent:95,  holidayNext:60,  toil:8  },
      { name:"Lisa Lowe",     team:"Team Manchester",unit:"Sales & Retentions",   holidayCurrent:110, holidayNext:70,  toil:12 },
      { name:"Sian Gibbs",    team:"Team London",    unit:"Sales & Retentions",   holidayCurrent:85,  holidayNext:55,  toil:5  },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service",     holidayCurrent:100, holidayNext:65,  toil:10 },
      { name:"Olivia Jenson", team:"Team Reading",   unit:"Customer Service",     holidayCurrent:115, holidayNext:75,  toil:7  },
      { name:"Ethan Reynolds",team:"Team Sheffield", unit:"Customer Service",     holidayCurrent:15,  holidayNext:50,  toil:-3  },
      { name:"Ava Mitchell",  team:"Team Manchester",unit:"Sales & Retentions",   holidayCurrent:105, holidayNext:85,  toil:9  },
      { name:"Gerard McGlynn",team:"Team Nashville", unit:"Sales & Retentions",   holidayCurrent:80,  holidayNext:45,  toil:6  },
      { name:"Rhys Turner",   team:"Team London",    unit:"Customer Service",     holidayCurrent:125, holidayNext:90,  toil:14 },
      { name:"Tom Collins",   team:"Team Reading",   unit:"Customer Service",     holidayCurrent:0,  holidayNext:240,  toil:2  }
    ];

    // -------- Time-off details (~6 per person across 2025–2026) --------
    const sampleDetails = [
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2025-01-15", end:"2025-01-22", deduction:56, days:7 },
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2025-03-10", end:"2025-03-12", deduction:24, days:3 },
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2025-07-01", end:"2025-07-05", deduction:40, days:5 },
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2025-12-23", end:"2025-12-24", deduction:16, days:2 },
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2026-04-14", end:"2026-04-16", deduction:24, days:3 },
      { name:"Craig Farley", team:"Team Reading", unit:"Customer Service", start:"2026-08-08", end:"2026-08-12", deduction:40, days:5 },

      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2025-02-10", end:"2025-02-12", deduction:24, days:3 },
      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2025-05-27", end:"2025-05-27", deduction:8,  days:1 },
      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2025-09-14", end:"2025-09-18", deduction:40, days:5 },
      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2026-01-04", end:"2026-01-06", deduction:24, days:3 },
      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2026-06-20", end:"2026-06-21", deduction:16, days:2 },
      { name:"Sasha Smith", team:"Team Sheffield", unit:"Customer Service", start:"2026-10-12", end:"2026-10-16", deduction:40, days:5 },

      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-01-30", end:"2025-01-31", deduction:16, days:2 },
      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-04-07", end:"2025-04-11", deduction:40, days:5 },
      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-08-24", end:"2025-08-28", deduction:40, days:5 },
      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-02-13", end:"2026-02-13", deduction:8,  days:1 },
      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-05-18", end:"2026-05-20", deduction:24, days:3 },
      { name:"Lisa Lowe", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-11-02", end:"2026-11-06", deduction:40, days:5 },

      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2025-02-24", end:"2025-02-26", deduction:24, days:3 },
      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2025-06-10", end:"2025-06-12", deduction:24, days:3 },
      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2025-10-19", end:"2025-10-23", deduction:40, days:5 },
      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2026-03-28", end:"2026-03-28", deduction:8,  days:1 },
      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2026-07-15", end:"2026-07-17", deduction:24, days:3 },
      { name:"Sian Gibbs", team:"Team London", unit:"Sales & Retentions", start:"2026-12-21", end:"2026-12-24", deduction:32, days:4 },

      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2025-03-03", end:"2025-03-07", deduction:40, days:5 },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2025-06-22", end:"2025-06-22", deduction:8,  days:1 },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2025-10-10", end:"2025-10-15", deduction:48, days:6 },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2026-01-19", end:"2026-01-21", deduction:24, days:3 },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2026-05-05", end:"2026-05-08", deduction:32, days:4 },
      { name:"John Thompson", team:"Team Nashville", unit:"Customer Service", start:"2026-09-14", end:"2026-09-18", deduction:40, days:5 },

      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2025-01-06", end:"2025-01-08", deduction:24, days:3 },
      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2025-05-12", end:"2025-05-16", deduction:40, days:5 },
      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2025-09-01", end:"2025-09-01", deduction:8,  days:1 },
      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2026-02-24", end:"2026-02-26", deduction:24, days:3 },
      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2026-06-29", end:"2026-07-03", deduction:40, days:5 },
      { name:"Olivia Jenson", team:"Team Reading", unit:"Customer Service", start:"2026-11-09", end:"2026-11-10", deduction:16, days:2 },

      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2025-02-03", end:"2025-02-04", deduction:16, days:2 },
      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2025-04-21", end:"2025-04-25", deduction:40, days:5 },
      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2025-08-05", end:"2025-08-07", deduction:24, days:3 },
      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2026-01-11", end:"2026-01-11", deduction:8,  days:1 },
      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2026-05-25", end:"2026-05-29", deduction:40, days:5 },
      { name:"Ethan Reynolds", team:"Team Sheffield", unit:"Customer Service", start:"2026-10-05", end:"2026-10-09", deduction:40, days:5 },

      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-03-17", end:"2025-03-20", deduction:32, days:4 },
      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-07-27", end:"2025-07-31", deduction:40, days:5 },
      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2025-12-14", end:"2025-12-15", deduction:16, days:2 },
      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-03-09", end:"2026-03-11", deduction:24, days:3 },
      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-07-20", end:"2026-07-24", deduction:40, days:5 },
      { name:"Ava Mitchell", team:"Team Manchester", unit:"Sales & Retentions", start:"2026-12-01", end:"2026-12-03", deduction:24, days:3 },

      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2025-01-22", end:"2025-01-23", deduction:16, days:2 },
      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2025-05-05", end:"2025-05-09", deduction:40, days:5 },
      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2025-09-28", end:"2025-09-30", deduction:24, days:3 },
      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2026-02-02", end:"2026-02-02", deduction:8,  days:1 },
      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2026-06-08", end:"2026-06-12", deduction:40, days:5 },
      { name:"Gerard McGlynn", team:"Team Nashville", unit:"Sales & Retentions", start:"2026-10-19", end:"2026-10-23", deduction:40, days:5 },

      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2025-02-17", end:"2025-02-19", deduction:24, days:3 },
      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2025-06-01", end:"2025-06-05", deduction:40, days:5 },
      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2025-10-26", end:"2025-10-27", deduction:16, days:2 },
      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2026-03-01", end:"2026-03-03", deduction:24, days:3 },
      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2026-07-06", end:"2026-07-10", deduction:40, days:5 },
      { name:"Rhys Turner", team:"Team London", unit:"Customer Service", start:"2026-12-14", end:"2026-12-18", deduction:40, days:5 },

      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2025-01-13", end:"2025-01-13", deduction:8,  days:1 },
      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2025-04-29", end:"2025-05-01", deduction:24, days:3 },
      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2025-09-07", end:"2025-09-11", deduction:40, days:5 },
      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2026-02-09", end:"2026-02-10", deduction:16, days:2 },
      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2026-05-31", end:"2026-06-04", deduction:40, days:5 },
      { name:"Tom Collins", team:"Team Reading", unit:"Customer Service", start:"2026-10-12", end:"2026-10-14", deduction:24, days:3 }
    ];

    // --- Utilities ---
    const toDate=(s)=>{ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,(m||1)-1,d||1); };
    function clearDetailsDateRange(){ document.getElementById('details-from').value=''; document.getElementById('details-to').value=''; updateTables(); }

    // CSV export
    function exportTableToCSV(tableId, filename){
      const table=document.getElementById(tableId); if(!table) return;
      const rows=[];
      const ths=table.querySelectorAll('thead tr th');
      if(ths.length){ rows.push(Array.from(ths).map(th=>th.textContent.trim())); }
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const cells=Array.from(tr.querySelectorAll('td')).map(td=>{
          const input=td.querySelector('input'); const v=input?input.value:td.textContent; return String(v).trim();
        });
        rows.push(cells);
      });
      const esc=v=>{ const val=String(v).replace(/"/g,'""'); return /[",\n]/.test(val)?`"${val}"`:val; };
      const csv=rows.map(r=>r.map(esc).join(',')).join('\n');
      const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename||'export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // --- Balance input colouring helper ---
    function classifyBalance(val){
      if(val <= 0) return 'negative';
      if(val < 15) return 'low';
      return '';
    }
    function applyColourToInput(inputEl){
      if(!inputEl) return;
      const v = parseFloat(inputEl.value);
      const cls = classifyBalance(isNaN(v)?0:v);
      inputEl.classList.remove('low','negative');
      if(cls) inputEl.classList.add(cls);
    }

    // --- Filtering & rendering ---
    function filterTables(){ updateTables(); }

    function updateTables(){
      const agent=document.getElementById("agent-select").value;
      const unit =document.getElementById("management-unit-select").value;
      const team =document.getElementById("team-select").value;
      const year =document.getElementById("year-select").value;
      const term =(document.getElementById("search-input").value||"").toLowerCase();

      const fromStr=(document.getElementById('details-from')?.value||'').trim();
      const toStr  =(document.getElementById('details-to')?.value||'').trim();
      const fromDate=toDate(fromStr), toDateVal=toDate(toStr);
      let validRange=true; if(fromDate && toDateVal && toDateVal<fromDate) validRange=false;

      const passAgent=n=>agent==="Select"||agent==="all"||n===agent;
      const passUnit =u=>unit==="Select"||unit==="all"||u===unit;
      const passTeam =t=>team==="Select"||team==="all"||t===team;
      const passSearch=n=>n.toLowerCase().includes(term);
      const passYear=d=>{
        if((fromDate||toDateVal)) return true; // if date range set, ignore year selector
        if(year==="Select"||year==="all") return true;
        return String(new Date(d).getFullYear())===String(year);
      };

      // --- Balances table render ---
      const balances=sampleBalances.filter(x=>passAgent(x.name)&&passUnit(x.unit)&&passTeam(x.team)&&passSearch(x.name));
      const bBody=document.getElementById("balances-table-body"); bBody.innerHTML="";
      balances.forEach(x=>{
        const clsHC = classifyBalance(x.holidayCurrent);
        const clsHN = classifyBalance(x.holidayNext);
        const clsTO = classifyBalance(x.toil);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${x.name}</td><td>${x.team}</td><td>${x.unit}</td>
          <td><input type="number" class="balance-input ${clsHC}" value="${x.holidayCurrent}"></td>
          <td><input type="number" class="balance-input ${clsHN}" value="${x.holidayNext}"></td>
          <td><input type="number" class="balance-input ${clsTO}" value="${x.toil}"></td>`;
        bBody.appendChild(tr);
      });

      // ensure live recolouring when user edits values
      // (event listener is attached once below, this just ensures freshly added inputs look right)
      document.querySelectorAll('#balances-table .balance-input').forEach(applyColourToInput);

      // --- Details table render ---
      const overlaps=(sStr,eStr)=>{
        if(!fromDate && !toDateVal) return true;
        if(!validRange) return false;
        const s=toDate(sStr), e=toDate(eStr); if(!s||!e) return false;
        const fromOk=fromDate ? e>=fromDate : true;
        const toOk  =toDateVal? s<=toDateVal: true;
        return fromOk && toOk;
      };

      const details=sampleDetails.filter(x=>
        passAgent(x.name)&&passUnit(x.unit)&&passTeam(x.team)&&passSearch(x.name)&&passYear(x.start)&&overlaps(x.start,x.end)
      );

      const dBody=document.getElementById("details-table-body"); dBody.innerHTML="";
      let totH=0, totD=0;
      details.forEach(x=>{
        totH+=Number(x.deduction)||0; totD+=Number(x.days)||0;
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${x.name}</td><td>${x.team}</td><td>${x.unit}</td>
          <td>${x.start}</td><td>${x.end}</td><td>${x.deduction}</td><td>${x.days}</td>`;
        dBody.appendChild(tr);
      });

      const sum=document.getElementById('details-summary');
      if(sum){
        if(!validRange){ sum.innerHTML=`<span style="color:#c0392b;">Invalid range: "To" is before "From".</span>`; }
        else{
          const bits=[]; if(fromStr) bits.push(`from <strong>${fromStr}</strong>`); if(toStr) bits.push(`to <strong>${toStr}</strong>`);
          sum.innerHTML=`Showing <strong>${details.length}</strong> record(s) ${bits.length?`(${bits.join(' ')})`:''}. Total deducted: <strong>${totH.toFixed(2)} hrs</strong> · Total days: <strong>${totD}</strong>`;
        }
      }
    }

    // --- Live recolour on input in balances table ---
    document.addEventListener('input', (e)=>{
      if(e.target && e.target.classList.contains('balance-input')){
        applyColourToInput(e.target);
      }
    });

    // -------- Calculator --------
    function calculateWeeklyHolidayHours(){
      const agents=parseFloat(document.getElementById("agents-count").value)||0;
      const avg=parseFloat(document.getElementById("avg-weekly-hours").value)||0;
      const pct=parseFloat(document.getElementById("holiday-percentage").value)||0;
      const total=agents*avg*(pct/100);
      document.getElementById("weekly-holiday-hours").textContent=total.toFixed(2);
      const daily=total/(parseFloat(document.getElementById("working-days").value)||5);
      document.getElementById("daily-holiday-hours").textContent=daily.toFixed(2);
      return total;
    }
    function calculateDayDistribution(){
      const total=calculateWeeklyHolidayHours(); const days=["mon","tue","wed","thu","fri","sat","sun"]; let sum=0;
      days.forEach(d=>{const pct=parseFloat(document.getElementById(`${d}-percent`).value)||0; sum+=pct; document.getElementById(`${d}-hours`).textContent=(total*(pct/100)).toFixed(2);});
      document.getElementById("total-percent").textContent=sum.toFixed(0)+"%"; document.getElementById("total-hours").textContent=total.toFixed(2);
    }
    function initializeMonthlyInputs(){
      const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
      const pct={"January":8,"February":9,"March":12,"April":7,"May":9,"June":6,"July":14,"August":13,"September":5,"October":7,"November":4,"December":6};
      const tb=document.getElementById("monthly-inputs"); tb.innerHTML="";
      months.forEach(m=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${m}</td><td><input type="number" id="${m.toLowerCase()}-percent" class="input-cell" value="${pct[m]}" step="0.01"></td>`; tb.appendChild(tr);});
    }
    function calculateMonthlyAllocation(){
      const months=["january","february","march","april","may","june","july","august","september","october","november","december"];
      let totalPct=0; months.forEach(m=>totalPct+=parseFloat(document.getElementById(`${m}-percent`).value)||0);
      const validation=document.getElementById("total-validation");
      if(Math.abs(totalPct-100)>0.1){validation.innerHTML=`<span style="color:red;">Total ${totalPct.toFixed(2)}% (should be 100%)</span>`;return;}
      const weekly=calculateWeeklyHolidayHours(); const tb=document.getElementById("monthly-results"); tb.innerHTML="";
      months.forEach(m=>{
        const pm=parseFloat(document.getElementById(`${m}-percent`).value)||0; let row=`<td>${m.charAt(0).toUpperCase()+m.slice(1)}</td>`; let sum=0;
        ["mon","tue","wed","thu","fri","sat","sun"].forEach(d=>{ const pd=parseFloat(document.getElementById(`${d}-percent`).value)||0; const hrs=weekly*(pd/100)*(pm/100)*(52/12); sum+=hrs; row+=`<td>${hrs.toFixed(2)}</td>`; });
        const tr=document.createElement("tr"); tr.innerHTML=row+`<td>${sum.toFixed(2)}</td>`; tb.appendChild(tr);
      });
    }
    function initializeCalculator(){
      ["agents-count","avg-weekly-hours","holiday-percentage","working-days","mon-percent","tue-percent","wed-percent","thu-percent","fri-percent","sat-percent","sun-percent"].forEach(id=>{
        document.getElementById(id).addEventListener("input",calculateDayDistribution);
      });
      initializeMonthlyInputs(); calculateDayDistribution();
    }

    // -------- Calendar --------
    let calendarData=[];
    function getDaysInMonth(y,m){return new Date(y,m,0).getDate();}
    function renderCalendarData(){
      const cal=document.getElementById('calendar'); cal.innerHTML='';
      const y=parseInt(document.getElementById('calendar-year-select').value,10);
      const m=parseInt(document.getElementById('calendar-month-select').value,10)-1;
      const dim=getDaysInMonth(y,m+1); const first=new Date(y,m,1); let fd=first.getDay(); fd=fd===0?6:fd-1;
      for(let i=0;i<fd;i++){const e=document.createElement('div');e.className='day empty';cal.appendChild(e);}
      for(let d=1;d<=dim;d++){
        let day=calendarData.find(x=>x.day===d);
        if(!day){day={day:d,balance:Math.round(Math.random()*50+20),startingBalance:70};calendarData.push(day);}
        let bg="var(--available-color)"; if(day.balance<=0.1) bg="var(--full-color)"; else if(day.balance/(day.startingBalance||70)<0.25) bg="var(--nearly-color)";
        const tile=document.createElement('div'); tile.className='day'; tile.style.background=bg;
        tile.innerHTML=`<div class="date">${d}</div>
          <div class="balance-info"><div>Available: <input class="day-input" type="number" min="0" max="999" value="${day.balance.toFixed(1)}" data-day="${d}"></div>
          <div style="font-size:11px;color:#9a9a9a;">Limit: ${(day.startingBalance||70).toFixed(1)}h</div></div>`;
        cal.appendChild(tile);
      }
    }
    function initializeCalendar(){
      const ms=document.getElementById('calendar-month-select'); const ys=document.getElementById('calendar-year-select');
      const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      ms.innerHTML=""; months.forEach((m,i)=>ms.appendChild(new Option(m,i+1)));
      ys.innerHTML=""; const yr=new Date().getFullYear(); for(let y=yr-1;y<=yr+2;y++) ys.appendChild(new Option(y,y));
      ms.value=(new Date().getMonth()+1); ys.value=yr; calendarData=[];
      ['calendar-month-select','calendar-year-select'].forEach(id=>document.getElementById(id).addEventListener('change',()=>{calendarData=[];renderCalendarData();}));
      document.getElementById('bulk-apply-btn').onclick=function(){
        const y=parseInt(document.getElementById('calendar-year-select').value,10);
        const m=parseInt(document.getElementById('calendar-month-select').value,10)-1;
        const dim=getDaysInMonth(y,m+1);
        document.querySelectorAll('.bulk-input').forEach(inp=>{
          const val=inp.value; if(val!=='' && !isNaN(val)){ const w=parseInt(inp.dataset.weekday,10);
            for(let d=1;d<=dim;d++){ const date=new Date(y,m,d); if(date.getDay()===w){
              let day=calendarData.find(x=>x.day===d); if(!day){day={day:d,balance:Number(val),startingBalance:70};calendarData.push(day);} else {day.balance=Number(val);}
            }}
          }
        });
        renderCalendarData();
      };
      document.getElementById('calendar-save-btn').onclick=()=>alert("Calendar changes saved! (For this demo, data is in memory only.)");
      document.addEventListener('input',e=>{
        if(e.target && e.target.classList.contains('day-input')){
          const day=parseInt(e.target.dataset.day,10); const val=Number(e.target.value);
          let d=calendarData.find(x=>x.day===day); if(d){d.balance=val; renderCalendarData();}
        }
      });
      renderCalendarData();
    }

    // -------- Tabs & init --------
    function openTabById(tabId){
      const tabs=document.getElementsByClassName("tabcontent");
      for(let i=0;i<tabs.length;i++){ tabs[i].style.display="none"; }
      const el=document.getElementById(tabId);
      if(el){ el.style.display="flex"; }
      const links=document.getElementsByClassName("tablinks");
      for(let i=0;i<links.length;i++){
        links[i].classList.toggle("active", links[i].getAttribute("data-tab")===tabId);
      }
      if(tabId==='TimeOffCalendar') renderCalendarData();
    }

    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('.tablinks');
      if(!btn) return;
      e.preventDefault();
      const tabId=btn.getAttribute('data-tab');
      openTabById(tabId);
    });

    window.onload=function(){
      openTabById('TimeOffBalances');
      updateTables();
      initializeCalculator();
      initializeCalendar();
    };
  </script>
</body>
</html>

